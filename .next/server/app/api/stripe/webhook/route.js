(()=>{var e={};e.id=287,e.ids=[287],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},21254:(e,t,r)=>{"use strict";r.d(t,{CF:()=>u,Er:()=>c,Ey:()=>d,VX:()=>l,th:()=>w});var s=r(80178),n=r(48361),i=r(53943);r(28142);var o=r(42687);let a=new TextEncoder().encode(process.env.JWT_SECRET||"leadcloser-default-secret-key-change-in-production");async function c(e){return await (0,o.hash)(e,10)}async function u(e,t){return await (0,o.verify)(e,t)}async function d(e){return await new s.P({id:e.id,email:e.email,name:e.name,role:e.role}).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime("7d").sign(a)}async function p(e){try{let{payload:t}=await (0,n.V)(e,a);return t}catch(e){return null}}function l(e,t){e.cookies.set({name:"auth-token",value:t,httpOnly:!0,secure:!0,sameSite:"strict",maxAge:604800,path:"/"})}async function w(){let e=(0,i.UL)(),t=e.get("auth-token")?.value;return t?await p(t):null}},24467:()=>{},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},36001:(e,t,r)=>{"use strict";r.d(t,{kY:()=>a,qw:()=>c,S5:()=>u,nV:()=>d});let s=require("mongodb"),n=process.env.MONGODB_URI||"",i=null,o=null;async function a(){if(o)return o;try{return i=new s.MongoClient(n),await i.connect(),o=i.db("leadcloser"),console.log("Connected to MongoDB"),o}catch(e){throw console.error("MongoDB connection error:",e),e}}async function c(){let e=await a();return{users:e.collection("users"),leads:e.collection("leads"),assessments:e.collection("assessments"),subscriptions:e.collection("subscriptions")}}async function u(e){let{subscriptions:t}=await c();return await t.find({userId:e,status:"active"}).sort({createdAt:-1}).limit(1).next()}async function d(e,t){let{subscriptions:r}=await c(),s=new Date;return await r.updateOne({_id:e},{$set:{...t,updatedAt:s}}),await r.findOne({_id:e})}},42687:e=>{"use strict";e.exports=require("@node-rs/bcrypt")},44556:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>v,routeModule:()=>g,serverHooks:()=>x,workAsyncStorage:()=>b,workUnitAsyncStorage:()=>f});var s={};r.r(s),r.d(s,{GET:()=>m,POST:()=>h,dynamic:()=>p,runtime:()=>l});var n=r(43007),i=r(44360),o=r(98343),a=r(28142),c=r(3809),u=r(21254),d=r(36001);let p="force-dynamic",l="nodejs",w=new c.A(process.env.STRIPE_SECRET_KEY||"",{apiVersion:"2023-10-16"});async function h(e){try{let t;let s=await e.text(),n=e.headers.get("stripe-signature")||"",i=process.env.STRIPE_WEBHOOK_SECRET||"";try{t=w.webhooks.constructEvent(s,n,i)}catch(e){return console.error("Webhook signature verification failed:",e),a.NextResponse.json({success:!1,message:"Webhook signature verification failed"},{status:400})}switch(t.type){case"checkout.session.completed":{let r=t.data.object,s=r.metadata?.userId,n=r.metadata?.planId;if(!s||!n)return console.error("Missing metadata in checkout session:",r.id),a.NextResponse.json({success:!1,message:"Missing metadata in checkout session"},{status:400});let i=r.subscription,o=await w.subscriptions.retrieve(i),c=new Date(1e3*o.current_period_start).toISOString(),u=new Date(1e3*o.current_period_end).toISOString(),p=await (0,d.S5)(s);p?await (0,d.nV)(p.id,{plan:n,status:"active",currentPeriodStart:c,currentPeriodEnd:u,stripeCustomerId:r.customer,stripeSubscriptionId:i}):await fetch(`${e.headers.get("origin")}/api/subscription`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:s,planId:n,stripeCustomerId:r.customer,stripeSubscriptionId:i,currentPeriodStart:c,currentPeriodEnd:u})});break}case"invoice.payment_succeeded":{let e=t.data.object.subscription;if(e){let t=await w.subscriptions.retrieve(e),{subscriptions:s}=await Promise.resolve().then(r.bind(r,36001)),n=await s.findOne({stripeSubscriptionId:e});n&&await (0,d.nV)(n.id,{currentPeriodStart:new Date(1e3*t.current_period_start).toISOString(),currentPeriodEnd:new Date(1e3*t.current_period_end).toISOString(),status:"active"})}break}case"customer.subscription.updated":{let e=t.data.object,{subscriptions:s}=await Promise.resolve().then(r.bind(r,36001)),n=await s.findOne({stripeSubscriptionId:e.id});n&&await (0,d.nV)(n.id,{status:e.status,currentPeriodStart:new Date(1e3*e.current_period_start).toISOString(),currentPeriodEnd:new Date(1e3*e.current_period_end).toISOString()});break}case"customer.subscription.deleted":{let e=t.data.object,{subscriptions:s}=await Promise.resolve().then(r.bind(r,36001)),n=await s.findOne({stripeSubscriptionId:e.id});n&&await (0,d.nV)(n.id,{status:"canceled"})}}return a.NextResponse.json({success:!0,received:!0})}catch(e){return console.error("Stripe webhook error:",e),a.NextResponse.json({success:!1,message:"Webhook error"},{status:500})}}async function m(e){try{if(!await (0,u.th)())return a.NextResponse.json({success:!1,message:"Authentication required"},{status:401});return a.NextResponse.json({success:!0,publishableKey:process.env.STRIPE_PUBLISHABLE_KEY})}catch(e){return console.error("Get Stripe config error:",e),a.NextResponse.json({success:!1,message:"An error occurred while fetching Stripe configuration"},{status:500})}}let g=new n.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/stripe/webhook/route",pathname:"/api/stripe/webhook",filename:"route",bundlePath:"app/api/stripe/webhook/route"},resolvedPagePath:"D:\\leadcloser\\leadcloser\\src\\app\\api\\stripe\\webhook\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:b,workUnitAsyncStorage:f,serverHooks:x}=g;function v(){return(0,o.patchFetch)({workAsyncStorage:b,workUnitAsyncStorage:f})}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},61419:()=>{},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},79428:e=>{"use strict";e.exports=require("buffer")},79646:e=>{"use strict";e.exports=require("child_process")},81630:e=>{"use strict";e.exports=require("http")},94735:e=>{"use strict";e.exports=require("events")}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[535,38,956,809],()=>r(44556));module.exports=s})();